# การปรับปรุงระบบแจ้งเตือนผู้ใช้เมื่อไม่มีข้อมูลบริบท

## ภาพรวม
ระบบได้รับการปรับปรุงเพื่อแจ้งเตือนผู้ใช้เมื่อไม่มีข้อมูลบริบทที่จำเป็นสำหรับการตอบคำถามต่อเนื่อง

## การเปลี่ยนแปลงที่สำคัญ

### 1. ปรับปรุงฟังก์ชัน `enhance_question_context()`

#### **ก่อนการปรับปรุง:**
```python
if zodiac:
    # ปรับปรุงคำถาม
    enhanced = question.replace("ราศีนี้", f"ราศี{zodiac}")
    return enhanced
else:
    # print(f"ไม่มีข้อมูลราศีสำหรับคำนวณ")
    pass  # ไม่แจ้งเตือนผู้ใช้

return question  # ส่งคำถามเดิมไปยัง GPT-4
```

#### **หลังการปรับปรุง:**
```python
if zodiac:
    # ปรับปรุงคำถาม
    enhanced = question.replace("ราศีนี้", f"ราศี{zodiac}")
    return enhanced
else:
    # แจ้งเตือนผู้ใช้เมื่อไม่มีข้อมูลราศี
    return "ขออภัยค่ะ ระบบไม่พบข้อมูลราศีของคุณ กรุณาระบุวันเกิดก่อน เช่น '09/02/2004 ราศีอะไร' หรือ 'ฉันเกิดวันที่ 9 กุมภาพันธ์ 2004'"

return question
```

### 2. ปรับปรุงฟังก์ชัน `ask_question_to_rag()`

#### **เพิ่มการตรวจสอบและแจ้งเตือน:**
```python
# ตรวจสอบและแจ้งเตือนเมื่อไม่มีบริบทสำหรับคำถามต่อเนื่อง
if is_follow_up_question and not user_context:
    return """ขออภัยค่ะ ระบบไม่พบข้อมูลบริบทการสนทนาของคุณ

กรุณาระบุวันเกิดก่อน เช่น:
- 09/02/2004 ราศีอะไร
- ฉันเกิดวันที่ 9 กุมภาพันธ์ 2004
- ดูดวงวันเกิด 09/02/2004

หลังจากนั้นคุณสามารถถามคำถามต่อเนื่องได้ เช่น 'แล้วราศีนี้มีลักษณะนิสัยยังไง'"""

if is_follow_up_question and user_context and not user_zodiac and not birth_info_from_question:
    return """ขออภัยค่ะ ระบบไม่พบข้อมูลราศีของคุณ

กรุณาระบุวันเกิดก่อน เช่น:
- 09/02/2004 ราศีอะไร
- ฉันเกิดวันที่ 9 กุมภาพันธ์ 2004

หลังจากนั้นคุณสามารถถามคำถามต่อเนื่องได้"""
```

#### **เพิ่มการตรวจสอบข้อความแจ้งเตือน:**
```python
# ปรับปรุงคำถามให้ชัดเจนขึ้นสำหรับคำถามต่อเนื่อง
enhanced_question = enhance_question_context(question, user_context)
if enhanced_question != question:
    # ตรวจสอบว่า enhanced_question เป็นข้อความแจ้งเตือนหรือไม่
    if enhanced_question.startswith("ขออภัยค่ะ ระบบไม่พบข้อมูลราศี"):
        return enhanced_question
    question = enhanced_question
```

### 3. ปรับปรุง System Prompt

#### **ก่อนการปรับปรุง:**
```
**ข้อห้ามสำคัญ:**
- ห้ามแจ้งว่าขาดข้อมูลหรือไม่สามารถให้คำแนะนำเฉพาะได้
- ห้ามใช้ข้อความเช่น "ไม่มีข้อมูลเพิ่มเติม", "ไม่สามารถให้คำแนะนำเฉพาะได้", "ข้อมูลไม่เพียงพอ"
- ให้ใช้ข้อมูลที่มีอยู่และให้คำแนะนำที่เป็นประโยชน์เสมอ
```

#### **หลังการปรับปรุง:**
```
**การจัดการข้อมูลที่ไม่ครบ:**
- หากไม่มีข้อมูลวันเกิดหรือราศี ให้แจ้งเตือนผู้ใช้ให้ระบุข้อมูลก่อน
- ใช้ข้อความ: "ขออภัยค่ะ ระบบไม่พบข้อมูลราศีของคุณ กรุณาระบุวันเกิดก่อน เช่น '09/02/2004 ราศีอะไร'"
- หากมีข้อมูลบางส่วนไม่ครบ ให้ใช้ความรู้โหราศาสตร์ทั่วไปในการให้คำแนะนำ
- ห้ามใช้ข้อความเช่น "ไม่มีข้อมูลเพิ่มเติม", "ไม่สามารถให้คำแนะนำเฉพาะได้", "ข้อมูลไม่เพียงพอ" เว้นแต่จะไม่มีข้อมูลวันเกิดหรือราศีเลย
```

## ตัวอย่างการทำงาน

### **สถานการณ์ที่ 1: คำถามต่อเนื่องโดยไม่มีบริบท**
```
ผู้ใช้: "ราศีนี้มีลักษณะนิสัยยังไง"
ระบบ: "ขออภัยค่ะ ระบบไม่พบข้อมูลราศีของคุณ กรุณาระบุวันเกิดก่อน เช่น '09/02/2004 ราศีอะไร' หรือ 'ฉันเกิดวันที่ 9 กุมภาพันธ์ 2004'"
```

### **สถานการณ์ที่ 2: คำถามต่อเนื่องที่มีบริบทบางส่วน**
```
ผู้ใช้: "ราศีนี้มีลักษณะนิสัยยังไง"
ระบบ: "ขออภัยค่ะ ระบบไม่พบข้อมูลราศีของคุณ กรุณาระบุวันเกิดก่อน เช่น '09/02/2004 ราศีอะไร' หรือ 'ฉันเกิดวันที่ 9 กุมภาพันธ์ 2004'"
```

### **สถานการณ์ที่ 3: คำถามต่อเนื่องที่มีบริบทครบถ้วน**
```
ผู้ใช้: "ราศีนี้มีลักษณะนิสัยยังไง"
ระบบ: "ราศีกุมภ์มีลักษณะนิสัยเป็นคนอิสระ..." (ตอบตามปกติ)
```

## ประโยชน์ของการปรับปรุง

### 1. **ความชัดเจนในการสื่อสาร**
- ผู้ใช้เข้าใจว่าระบบต้องการข้อมูลอะไร
- ลดความสับสนในการใช้งาน

### 2. **การใช้งานที่มีประสิทธิภาพ**
- ผู้ใช้ไม่ต้องเดาว่าระบบต้องการข้อมูลอะไร
- ลดการถามคำถามซ้ำๆ

### 3. **ประสบการณ์ผู้ใช้ที่ดีขึ้น**
- ระบบให้คำแนะนำที่ชัดเจน
- ผู้ใช้รู้ว่าต้องทำอะไรต่อไป

## การทดสอบ

### **ไฟล์ทดสอบ: `test_context_notifications.py`**
```python
# ทดสอบการแจ้งเตือนเมื่อไม่มีข้อมูลบริบท
def test_context_notifications():
    # ทดสอบคำถามต่อเนื่องโดยไม่มีบริบท
    result = ask_question_to_rag("ราศีนี้มีลักษณะนิสัยยังไง", "test_user_no_context")
    print(f"ผลลัพธ์: {result}")
    
    # ทดสอบคำถามต่อเนื่องที่มีบริบทบางส่วน
    result = ask_question_to_rag("ราศีนี้มีลักษณะนิสัยยังไง", "test_user_partial_context")
    print(f"ผลลัพธ์: {result}")
```

### **การรันทดสอบ:**
```bash
python test_context_notifications.py
```

## สรุป

การปรับปรุงนี้ทำให้ระบบสามารถ:
1. **แจ้งเตือนผู้ใช้** เมื่อไม่มีข้อมูลบริบทที่จำเป็น
2. **ให้คำแนะนำที่ชัดเจน** เกี่ยวกับข้อมูลที่ต้องการ
3. **ปรับปรุงประสบการณ์ผู้ใช้** โดยลดความสับสน
4. **รักษาความต่อเนื่องของการสนทนา** เมื่อมีข้อมูลครบถ้วน

ระบบจะทำงานได้ดีขึ้นและผู้ใช้จะได้รับประสบการณ์ที่ดีขึ้นในการใช้งานครับ!
