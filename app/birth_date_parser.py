import re
from datetime import datetime
import logging
import os
from pymongo import MongoClient
from dotenv import load_dotenv
from .astronomical_calculator import AstronomicalCalculator


# ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ logger
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# ‡πÇ‡∏´‡∏•‡∏î environment variables
load_dotenv()

class BirthDateParser:
    """Class ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ï‡πà‡∏≤‡∏á‡πÜ"""
    
    def __init__(self):
        # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏î‡∏≤‡∏£‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå
        self.astronomical_calculator = AstronomicalCalculator()
        
        # Dictionary ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏õ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÑ‡∏ó‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
        self.thai_months = {
            '‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°': 1, '‡∏°.‡∏Ñ.': 1, '‡∏°‡∏Ñ': 1,
            '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå': 2, '‡∏Å.‡∏û.': 2, '‡∏Å‡∏û': 2,
            '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°': 3, '‡∏°‡∏µ.‡∏Ñ.': 3, '‡∏°‡∏µ‡∏Ñ': 3,
            '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô': 4, '‡πÄ‡∏°.‡∏¢.': 4, '‡πÄ‡∏°‡∏¢': 4,
            '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°': 5, '‡∏û.‡∏Ñ.': 5, '‡∏û‡∏Ñ': 5,
            '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô': 6, '‡∏°‡∏¥.‡∏¢.': 6, '‡∏°‡∏¥‡∏¢': 6,
            '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°': 7, '‡∏Å.‡∏Ñ.': 7, '‡∏Å‡∏Ñ': 7,
            '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°': 8, '‡∏™.‡∏Ñ.': 8, '‡∏™‡∏Ñ': 8,
            '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô': 9, '‡∏Å.‡∏¢.': 9, '‡∏Å‡∏¢': 9,
            '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°': 10, '‡∏ï.‡∏Ñ.': 10, '‡∏ï‡∏Ñ': 10,
            '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô': 11, '‡∏û.‡∏¢.': 11, '‡∏û‡∏¢': 11,
            '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°': 12, '‡∏ò.‡∏Ñ.': 12, '‡∏ò‡∏Ñ': 12
        }
        
        # Dictionary ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏õ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
        self.english_months = {
            'january': 1, 'jan': 1,
            'february': 2, 'feb': 2,
            'march': 3, 'mar': 3,
            'april': 4, 'apr': 4,
            'may': 5,
            'june': 6, 'jun': 6,
            'july': 7, 'jul': 7,
            'august': 8, 'aug': 8,
            'september': 9, 'sep': 9, 'sept': 9,
            'october': 10, 'oct': 10,
            'november': 11, 'nov': 11,
            'december': 12, 'dec': 12
        }
        
        # Pattern ‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö regex
        self.patterns = [
            # ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö dd/mm/yyyy, dd-mm-yyyy, dd.mm.yyyy (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏¥‡∏î‡∏Å‡∏±‡∏ô)
            (r'(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{2,4})', 'dmy'),
            
            # ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö yyyy/mm/dd, yyyy-mm-dd (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏¥‡∏î‡∏Å‡∏±‡∏ô)
            (r'(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})', 'ymd'),
            
            # ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö dd mm yyyy (‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡∏£‡∏£‡∏Ñ)
            (r'\b(\d{1,2})\s+(\d{1,2})\s+(\d{2,4})\b', 'dmy'),
            
            # ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà X ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô Y ‡∏õ‡∏µ Z
            (r'‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà\s*(\d{1,2})\s*‡πÄ‡∏î‡∏∑‡∏≠‡∏ô\s*(\d{1,2})\s*‡∏õ‡∏µ\s*(\d{2,4})', 'dmy'),
            
            # ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö ‡πÄ‡∏Å‡∏¥‡∏î‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà X/Y/Z
            (r'‡πÄ‡∏Å‡∏¥‡∏î.*?(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})', 'dmy'),
            
            # ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö ‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î X/Y/Z
            (r'‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î.*?(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})', 'dmy'),
            
            # ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ó‡∏¢ ‡πÄ‡∏ä‡πà‡∏ô 7 ‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏° 2003
            (r'(\d{1,2})\s*(' + '|'.join(self.thai_months.keys()) + r')\s*(\d{2,4})', 'thai_month'),
            
            # ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏© ‡πÄ‡∏ä‡πà‡∏ô 7 January 2003
            (r'(\d{1,2})\s*(' + '|'.join(self.english_months.keys()) + r')\s*(\d{2,4})', 'english_month'),
            
            # ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö ‡πÅ‡∏Ñ‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 8 ‡∏´‡∏•‡∏±‡∏Å ‡πÄ‡∏ä‡πà‡∏ô 07092003 (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏¥‡∏î‡∏Å‡∏±‡∏ô)
            (r'(\d{2})(\d{2})(\d{4})', 'ddmmyyyy'),
            
            # ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö ‡∏õ‡∏µ‡πÑ‡∏ó‡∏¢ (‡∏û.‡∏®.) ‡πÄ‡∏ä‡πà‡∏ô 7/9/2546
            (r'(\d{1,2})[\/\-](\d{1,2})[\/\-](25\d{2})', 'thai_year'),
        ]
        
        # Pattern ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Å‡∏¥‡∏î
        self.time_patterns = [
            # ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö HH:MM ‡πÄ‡∏ä‡πà‡∏ô 14:30, 2:30
            (r'(\d{1,2}):(\d{2})', 'time'),
            # ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö HH.MM ‡πÄ‡∏ä‡πà‡∏ô 14.30, 2.30
            (r'(\d{1,2})\.(\d{2})', 'time'),
            # ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö HH.MM‡∏ô. ‡πÄ‡∏ä‡πà‡∏ô 07.07‡∏ô., 14.30‡∏ô.
            (r'(\d{1,2})\.(\d{2})‡∏ô\.', 'time'),
            # ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö HH MM ‡πÄ‡∏ä‡πà‡∏ô 14 30, 2 30
            (r'(\d{1,2})\s+(\d{2})', 'time'),
            # ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö ‡πÄ‡∏ß‡∏•‡∏≤ X ‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤ Y ‡∏ô‡∏≤‡∏ó‡∏µ
            (r'‡πÄ‡∏ß‡∏•‡∏≤\s*(\d{1,2})\s*‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤\s*(\d{1,2})\s*‡∏ô‡∏≤‡∏ó‡∏µ', 'time'),
            # ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö X ‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤ Y ‡∏ô‡∏≤‡∏ó‡∏µ
            (r'(\d{1,2})\s*‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤\s*(\d{1,2})\s*‡∏ô‡∏≤‡∏ó‡∏µ', 'time'),
            # ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö X ‡∏ô. Y ‡∏ô‡∏≤‡∏ó‡∏µ
            (r'(\d{1,2})\s*‡∏ô\.\s*(\d{1,2})\s*‡∏ô‡∏≤‡∏ó‡∏µ', 'time'),
        ]
        
        # Dictionary ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡πÅ‡∏•‡∏∞‡∏û‡∏¥‡∏Å‡∏±‡∏î
        self.location_coordinates = {
            # ‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡πÉ‡∏´‡∏ç‡πà‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢
            '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û': {'lat': 13.7563, 'lon': 100.5018},
            '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø': {'lat': 13.7563, 'lon': 100.5018},
            '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£': {'lat': 13.7563, 'lon': 100.5018},
            '‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà': {'lat': 18.7883, 'lon': 98.9853},
            '‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏£‡∏≤‡∏¢': {'lat': 19.9105, 'lon': 99.8405},
            '‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤': {'lat': 14.9799, 'lon': 102.0978},
            '‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô': {'lat': 16.4419, 'lon': 102.8359},
            '‡∏≠‡∏∏‡∏î‡∏£‡∏ò‡∏≤‡∏ô‡∏µ': {'lat': 17.4138, 'lon': 102.7873},
            '‡∏≠‡∏∏‡∏ö‡∏•‡∏£‡∏≤‡∏ä‡∏ò‡∏≤‡∏ô‡∏µ': {'lat': 15.2287, 'lon': 104.8563},
            '‡∏™‡∏á‡∏Ç‡∏•‡∏≤': {'lat': 7.0061, 'lon': 100.5008},
            '‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï': {'lat': 7.8804, 'lon': 98.3923},
            '‡∏û‡∏±‡∏ó‡∏¢‡∏≤': {'lat': 12.9236, 'lon': 100.8825},
            '‡∏´‡∏±‡∏ß‡∏´‡∏¥‡∏ô': {'lat': 12.5684, 'lon': 99.9576},
            '‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ': {'lat': 9.1382, 'lon': 99.3215},
            '‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏ò‡∏£‡∏£‡∏°‡∏£‡∏≤‡∏ä': {'lat': 8.4304, 'lon': 99.9631},
            '‡∏¢‡∏∞‡∏•‡∏≤': {'lat': 6.5414, 'lon': 101.2804},
            '‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ': {'lat': 6.8694, 'lon': 101.2503},
            '‡∏ô‡∏£‡∏≤‡∏ò‡∏¥‡∏ß‡∏≤‡∏™': {'lat': 6.4255, 'lon': 101.8253},
            '‡∏£‡∏∞‡∏¢‡∏≠‡∏á': {'lat': 12.6819, 'lon': 101.2819},
            '‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ': {'lat': 13.3611, 'lon': 100.9847},
            '‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£': {'lat': 13.5991, 'lon': 100.5998},
            '‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ': {'lat': 13.8668, 'lon': 100.5168},
            '‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ': {'lat': 14.0208, 'lon': 100.5250},
            '‡∏ô‡∏Ñ‡∏£‡∏õ‡∏ê‡∏°': {'lat': 13.8199, 'lon': 100.0623},
            '‡∏£‡∏≤‡∏ä‡∏ö‡∏∏‡∏£‡∏µ': {'lat': 13.5360, 'lon': 99.8134},
            '‡∏Å‡∏≤‡∏ç‡∏à‡∏ô‡∏ö‡∏∏‡∏£‡∏µ': {'lat': 14.0228, 'lon': 99.5328},
            '‡∏™‡∏∏‡∏û‡∏£‡∏£‡∏ì‡∏ö‡∏∏‡∏£‡∏µ': {'lat': 14.4745, 'lon': 100.1226},
            '‡∏≠‡πà‡∏≤‡∏á‡∏ó‡∏≠‡∏á': {'lat': 14.5896, 'lon': 100.4550},
            '‡∏•‡∏û‡∏ö‡∏∏‡∏£‡∏µ': {'lat': 14.7995, 'lon': 100.6534},
            '‡∏™‡∏¥‡∏á‡∏´‡πå‡∏ö‡∏∏‡∏£‡∏µ': {'lat': 14.8936, 'lon': 100.3969},
            '‡∏ä‡∏±‡∏¢‡∏ô‡∏≤‡∏ó': {'lat': 15.1855, 'lon': 100.1251},
            '‡∏≠‡∏∏‡∏ó‡∏±‡∏¢‡∏ò‡∏≤‡∏ô‡∏µ': {'lat': 15.3795, 'lon': 99.5089},
            '‡∏Å‡∏≥‡πÅ‡∏û‡∏á‡πÄ‡∏û‡∏ä‡∏£': {'lat': 16.4828, 'lon': 99.5227},
            '‡∏ï‡∏≤‡∏Å': {'lat': 16.8845, 'lon': 98.8565},
            '‡∏™‡∏∏‡πÇ‡∏Ç‡∏ó‡∏±‡∏¢': {'lat': 17.0056, 'lon': 99.8262},
            '‡∏û‡∏¥‡∏©‡∏ì‡∏∏‡πÇ‡∏•‡∏Å': {'lat': 16.8211, 'lon': 100.2659},
            '‡∏û‡∏¥‡∏à‡∏¥‡∏ï‡∏£': {'lat': 16.4388, 'lon': 100.3488},
            '‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏π‡∏£‡∏ì‡πå': {'lat': 16.4190, 'lon': 101.1606},
            '‡∏•‡∏≥‡∏õ‡∏≤‡∏á': {'lat': 18.2980, 'lon': 99.4909},
            '‡∏•‡∏≥‡∏û‡∏π‡∏ô': {'lat': 18.5801, 'lon': 99.0078},
            '‡πÅ‡∏°‡πà‡∏Æ‡πà‡∏≠‡∏á‡∏™‡∏≠‡∏ô': {'lat': 19.3019, 'lon': 97.9651},
            '‡∏ô‡πà‡∏≤‡∏ô': {'lat': 18.7756, 'lon': 100.7730},
            '‡∏û‡∏∞‡πÄ‡∏¢‡∏≤': {'lat': 19.1920, 'lon': 99.9016},
            '‡πÅ‡∏û‡∏£‡πà': {'lat': 18.1449, 'lon': 100.1406},
            '‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå': {'lat': 15.7047, 'lon': 100.1371},
            '‡∏≠‡∏∏‡∏ï‡∏£‡∏î‡∏¥‡∏ï‡∏ñ‡πå': {'lat': 17.6201, 'lon': 100.0993},
            '‡∏Å‡∏≤‡∏¨‡∏™‡∏¥‡∏ô‡∏ò‡∏∏‡πå': {'lat': 16.4419, 'lon': 103.5060},
            '‡∏™‡∏Å‡∏•‡∏ô‡∏Ñ‡∏£': {'lat': 17.1536, 'lon': 104.1409},
            '‡∏ô‡∏Ñ‡∏£‡∏û‡∏ô‡∏°': {'lat': 17.4074, 'lon': 104.7789},
            '‡∏°‡∏∏‡∏Å‡∏î‡∏≤‡∏´‡∏≤‡∏£': {'lat': 16.5453, 'lon': 104.7235},
            '‡∏£‡πâ‡∏≠‡∏¢‡πÄ‡∏≠‡πá‡∏î': {'lat': 16.0538, 'lon': 103.6530},
            '‡∏¢‡πÇ‡∏™‡∏ò‡∏£': {'lat': 15.7924, 'lon': 104.1453},
            '‡∏≠‡∏≥‡∏ô‡∏≤‡∏à‡πÄ‡∏à‡∏£‡∏¥‡∏ç': {'lat': 15.8650, 'lon': 104.6258},
            '‡∏´‡∏ô‡∏≠‡∏á‡∏ö‡∏±‡∏ß‡∏•‡∏≥‡∏†‡∏π': {'lat': 17.2218, 'lon': 102.4447},
            '‡πÄ‡∏•‡∏¢': {'lat': 17.4860, 'lon': 101.7223},
            '‡∏´‡∏ô‡∏≠‡∏á‡∏Ñ‡∏≤‡∏¢': {'lat': 17.8783, 'lon': 102.7413},
            '‡∏°‡∏´‡∏≤‡∏™‡∏≤‡∏£‡∏Ñ‡∏≤‡∏°': {'lat': 16.1844, 'lon': 103.3020},
            '‡∏™‡∏∏‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå': {'lat': 14.8826, 'lon': 103.4938},
            '‡∏®‡∏£‡∏µ‡∏™‡∏∞‡πÄ‡∏Å‡∏©': {'lat': 15.1186, 'lon': 104.3220},
            '‡∏ö‡∏∏‡∏£‡∏µ‡∏£‡∏±‡∏°‡∏¢‡πå': {'lat': 14.9932, 'lon': 103.1029},
            '‡∏ä‡∏±‡∏¢‡∏†‡∏π‡∏°‡∏¥': {'lat': 15.8067, 'lon': 102.0313},
            '‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏∏‡∏£‡∏µ': {'lat': 13.1119, 'lon': 99.9447},
            '‡∏õ‡∏£‡∏∞‡∏à‡∏ß‡∏ö‡∏Ñ‡∏µ‡∏£‡∏µ‡∏Ç‡∏±‡∏ô‡∏ò‡πå': {'lat': 11.8124, 'lon': 99.7979},
            '‡∏ä‡∏∏‡∏°‡∏û‡∏£': {'lat': 10.4930, 'lon': 99.1800},
            '‡∏£‡∏∞‡∏ô‡∏≠‡∏á': {'lat': 9.9658, 'lon': 98.6347},
            '‡∏Å‡∏£‡∏∞‡∏ö‡∏µ‡πà': {'lat': 8.0863, 'lon': 98.9063},
            '‡∏ï‡∏£‡∏±‡∏á': {'lat': 7.5567, 'lon': 99.6114},
            '‡∏û‡∏±‡∏á‡∏á‡∏≤': {'lat': 8.4505, 'lon': 98.5319},
            '‡∏™‡∏ï‡∏π‡∏•': {'lat': 6.6238, 'lon': 100.0674},
            '‡∏ô‡∏Ñ‡∏£‡∏ô‡∏≤‡∏¢‡∏Å': {'lat': 14.2069, 'lon': 101.2131},
            '‡∏™‡∏£‡∏∞‡πÅ‡∏Å‡πâ‡∏ß': {'lat': 13.8240, 'lon': 102.0644},
            '‡∏™‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏µ': {'lat': 14.5289, 'lon': 100.9101},
            '‡∏ï‡∏£‡∏≤‡∏î': {'lat': 12.2436, 'lon': 102.5150},
            '‡∏à‡∏±‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ': {'lat': 12.6117, 'lon': 102.1038},
            '‡∏â‡∏∞‡πÄ‡∏ä‡∏¥‡∏á‡πÄ‡∏ó‡∏£‡∏≤': {'lat': 13.6904, 'lon': 101.0779},
            '‡∏õ‡∏£‡∏≤‡∏à‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ': {'lat': 14.0507, 'lon': 101.3703},
            '‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£': {'lat': 13.5991, 'lon': 100.2744},
            '‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏á‡∏Ñ‡∏£‡∏≤‡∏°': {'lat': 13.4149, 'lon': 100.0026},
            '‡∏ô‡∏Ñ‡∏£‡∏ô‡∏≤‡∏¢‡∏Å': {'lat': 14.2069, 'lon': 101.2131},
            '‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤': {'lat': 14.3692, 'lon': 100.5877},
            '‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤': {'lat': 14.3692, 'lon': 100.5877},
        }

    def extract_birth_date(self, text: str) -> str:
        """
        ‡πÅ‡∏¢‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
        
        Args:
            text (str): ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏¢‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î
            
        Returns:
            str: ‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö dd/mm/yyyy ‡∏´‡∏£‡∏∑‡∏≠ None ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏ö
        """
        text = text.lower().strip()
        logger.info(f"‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏¢‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å: {text}")
        
        for pattern, format_type in self.patterns:
            matches = re.findall(pattern, text, re.IGNORECASE)
            
            if matches:
                match = matches[0]
                logger.info(f"‡∏û‡∏ö pattern {format_type}: {match}")
                
                try:
                    birth_date = self._parse_match(match, format_type)
                    if birth_date:
                        logger.info(f"‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: {birth_date}")
                        return birth_date
                except Exception as e:
                    logger.warning(f"‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: {e}")
                    continue
        
        logger.warning("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°")
        return None

    def extract_birth_time(self, text: str) -> str:
        """
        ‡πÅ‡∏¢‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
        
        Args:
            text (str): ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏¢‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Å‡∏¥‡∏î
            
        Returns:
            str: ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Å‡∏¥‡∏î‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö HH:MM ‡∏´‡∏£‡∏∑‡∏≠ None ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏ö
        """
        text = text.lower().strip()
        logger.info(f"‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏¢‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å: {text}")
        
        for pattern, format_type in self.time_patterns:
            matches = re.findall(pattern, text, re.IGNORECASE)
            
            if matches:
                match = matches[0]
                logger.info(f"‡∏û‡∏ö time pattern {format_type}: {match}")
                
                try:
                    birth_time = self._parse_time_match(match, format_type)
                    if birth_time:
                        logger.info(f"‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Å‡∏¥‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: {birth_time}")
                        return birth_time
                except Exception as e:
                    logger.warning(f"‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Å‡∏¥‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: {e}")
                    continue
        
        logger.warning("‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Å‡∏¥‡∏î‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°")
        return None

    def extract_birth_location(self, text: str) -> dict:
        """
        ‡πÅ‡∏¢‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
        
        Args:
            text (str): ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏¢‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î
            
        Returns:
            dict: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î {'location': str, 'latitude': float, 'longitude': float}
        """
        text_lower = text.lower().strip()
        logger.info(f"‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏¢‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å: {text}")
        
        # ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
        for location_name, coordinates in self.location_coordinates.items():
            if location_name.lower() in text_lower:
                logger.info(f"‡∏û‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î: {location_name}")
                return {
                    'location': location_name,
                    'latitude': coordinates['lat'],
                    'longitude': coordinates['lon']
                }
        
        # ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° ‡πÉ‡∏ä‡πâ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
        logger.info("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° ‡πÉ‡∏ä‡πâ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Ascendant")
        return {
            'location': '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø',
            'latitude': 13.7563,
            'longitude': 100.5018
        }

    def extract_birth_info(self, text: str) -> dict:
        """
        ‡πÅ‡∏¢‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Å‡∏¥‡∏î ‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
        
        Args:
            text (str): ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏¢‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            
        Returns:
            dict: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Å‡∏¥‡∏î ‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î
        """
        birth_date = self.extract_birth_date(text)
        birth_time = self.extract_birth_time(text)
        birth_location = self.extract_birth_location(text)
        
        return {
            'date': birth_date,
            'time': birth_time,
            'location': birth_location['location'],
            'latitude': birth_location['latitude'],
            'longitude': birth_location['longitude']
        }

    def _parse_match(self, match, format_type):
        """‡πÅ‡∏õ‡∏•‡∏á match ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö dd/mm/yyyy"""
        
        if format_type == 'dmy':
            day, month, year = match
            return self._format_date(int(day), int(month), int(year))
            
        elif format_type == 'ymd':
            year, month, day = match
            return self._format_date(int(day), int(month), int(year))
            
        elif format_type == 'thai_month':
            day, month_name, year = match
            month = self.thai_months.get(month_name.lower())
            if month:
                return self._format_date(int(day), month, int(year))
                
        elif format_type == 'english_month':
            day, month_name, year = match
            month = self.english_months.get(month_name.lower())
            if month:
                return self._format_date(int(day), month, int(year))
                
        elif format_type == 'ddmmyyyy':
            day, month, year = match
            return self._format_date(int(day), int(month), int(year))
            
        elif format_type == 'thai_year':
            day, month, thai_year = match
            # ‡πÅ‡∏õ‡∏•‡∏á ‡∏û.‡∏®. ‡πÄ‡∏õ‡πá‡∏ô ‡∏Ñ.‡∏®.
            year = int(thai_year) - 543
            return self._format_date(int(day), int(month), year)
        
        return None

    def _parse_time_match(self, match, format_type):
        """‡πÅ‡∏õ‡∏•‡∏á match ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö HH:MM"""
        if format_type == 'time':
            hour, minute = match
            hour = int(hour)
            minute = int(minute)
            
            # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡πÄ‡∏ß‡∏•‡∏≤
            if not (0 <= hour <= 23):
                return None
            if not (0 <= minute <= 59):
                return None
            
            return f"{hour:02d}:{minute:02d}"
        
        return None

    def _format_date(self, day, month, year):
        """‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"""
        
        # ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏µ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô 4 ‡∏´‡∏•‡∏±‡∏Å
        if year < 100:
            if year <= 30:  # 00-30 = 2000-2030
                year += 2000
            else:  # 31-99 = 1931-1999
                year += 1900
        
        # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
        if not (1 <= month <= 12):
            return None
            
        if not (1 <= day <= 31):
            return None
            
        if not (1900 <= year <= datetime.now().year + 10):
            return None
        
        # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
        try:
            datetime(year, month, day)
        except ValueError:
            return None
        
        # ‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö dd/mm/yyyy
        return f"{day:02d}/{month:02d}/{year}"

    def detect_zodiac_sign_in_message(self, text: str) -> dict:
        """
        ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏®‡∏µ‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
        
        Args:
            text (str): ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
            
        Returns:
            dict: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏®‡∏µ‡∏ó‡∏µ‡πà‡∏û‡∏ö {'sign': '‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏®‡∏µ', 'element': '‡∏ò‡∏≤‡∏ï‡∏∏', 'quality': '‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û', 'english_name': '‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©'} ‡∏´‡∏£‡∏∑‡∏≠ None
        """
        text_lower = text.lower()
        
        # ‡∏£‡∏≤‡∏®‡∏µ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        zodiac_data = {
            'aries': {
                'name': '‡πÄ‡∏°‡∏©', 'element': '‡πÑ‡∏ü', 'quality': 'Cardinal', 'keywords': ['‡πÄ‡∏°‡∏©', '‡∏£‡∏≤‡∏®‡∏µ‡πÄ‡∏°‡∏©'],
                'description': '‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡πÄ‡∏ï‡πá‡∏°‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏£‡∏∞‡∏ï‡∏∑‡∏≠‡∏£‡∏∑‡∏≠‡∏•‡πâ‡∏ô ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏ô‡∏≥ ‡∏Å‡∏•‡πâ‡∏≤‡∏´‡∏≤‡∏ç‡πÅ‡∏•‡∏∞‡∏ä‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô'
            },
            'taurus': {
                'name': '‡∏û‡∏§‡∏©‡∏†', 'element': '‡∏î‡∏¥‡∏ô', 'quality': 'Fixed', 'keywords': ['‡∏û‡∏§‡∏©‡∏†', '‡∏£‡∏≤‡∏®‡∏µ‡∏û‡∏§‡∏©‡∏†'],
                'description': '‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏î‡∏ó‡∏ô ‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á ‡∏£‡∏±‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏á‡∏ö ‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏ô‡∏ä‡∏≠‡∏ö‡πÉ‡∏ô‡∏™‡∏∏‡∏ô‡∏ó‡∏£‡∏µ‡∏¢‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏á‡∏≤‡∏°'
            },
            'gemini': {
                'name': '‡πÄ‡∏°‡∏ñ‡∏∏‡∏ô', 'element': '‡∏•‡∏°', 'quality': 'Mutable', 'keywords': ['‡πÄ‡∏°‡∏ñ‡∏∏‡∏ô', '‡∏£‡∏≤‡∏®‡∏µ‡πÄ‡∏°‡∏ñ‡∏∏‡∏ô'],
                'description': '‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£ ‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏Å‡πà‡∏á ‡∏≠‡∏¢‡∏≤‡∏Å‡∏£‡∏π‡πâ‡∏≠‡∏¢‡∏≤‡∏Å‡πÄ‡∏´‡πá‡∏ô ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏£‡∏£‡∏Ñ‡πå'
            },
            'cancer': {
                'name': '‡∏Å‡∏£‡∏Å‡∏é', 'element': '‡∏ô‡πâ‡∏≥', 'quality': 'Cardinal', 'keywords': ['‡∏Å‡∏£‡∏Å‡∏é', '‡∏£‡∏≤‡∏®‡∏µ‡∏Å‡∏£‡∏Å‡∏é'],
                'description': '‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡πà‡∏≠‡∏ô‡πÇ‡∏¢‡∏ô ‡∏£‡∏±‡∏Å‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß ‡∏°‡∏µ‡∏™‡∏±‡∏ç‡∏ä‡∏≤‡∏ï‡∏ç‡∏≤‡∏ì‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏Å‡∏õ‡πâ‡∏≠‡∏á‡∏î‡∏π‡πÅ‡∏• ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡πÑ‡∏ß'
            },
            'leo': {
                'name': '‡∏™‡∏¥‡∏á‡∏´‡πå', 'element': '‡πÑ‡∏ü', 'quality': 'Fixed', 'keywords': ['‡∏™‡∏¥‡∏á‡∏´‡πå', '‡∏£‡∏≤‡∏®‡∏µ‡∏™‡∏¥‡∏á‡∏´‡πå'],
                'description': '‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à ‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏ô‡∏≥‡πÇ‡∏î‡∏¢‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥ ‡πÉ‡∏à‡∏Å‡∏ß‡πâ‡∏≤‡∏á ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏£‡∏£‡∏Ñ‡πå'
            },
            'virgo': {
                'name': '‡∏Å‡∏±‡∏ô‡∏¢‡πå', 'element': '‡∏î‡∏¥‡∏ô', 'quality': 'Mutable', 'keywords': ['‡∏Å‡∏±‡∏ô‡∏¢‡πå', '‡∏£‡∏≤‡∏®‡∏µ‡∏Å‡∏±‡∏ô‡∏¢‡πå'],
                'description': '‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏£‡∏≠‡∏ö‡∏Ñ‡∏≠‡∏ö ‡∏°‡∏µ‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö‡∏ß‡∏¥‡∏ô‡∏±‡∏¢ ‡∏ä‡πà‡∏≤‡∏á‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï ‡πÅ‡∏•‡∏∞‡πÉ‡∏™‡πà‡πÉ‡∏à‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î'
            },
            'libra': {
                'name': '‡∏ï‡∏∏‡∏•', 'element': '‡∏•‡∏°', 'quality': 'Cardinal', 'keywords': ['‡∏ï‡∏∏‡∏•', '‡∏£‡∏≤‡∏®‡∏µ‡∏ï‡∏∏‡∏•'],
                'description': '‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏∏‡∏ï‡∏¥‡∏ò‡∏£‡∏£‡∏° ‡∏°‡∏µ‡πÄ‡∏™‡∏ô‡πà‡∏´‡πå ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡πÄ‡∏Å‡πà‡∏á ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏ß‡∏á‡∏´‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏°‡∏î‡∏∏‡∏•‡πÉ‡∏ô‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï'
            },
            'scorpio': {
                'name': '‡∏û‡∏¥‡∏à‡∏¥‡∏Å', 'element': '‡∏ô‡πâ‡∏≥', 'quality': 'Fixed', 'keywords': ['‡∏û‡∏¥‡∏à‡∏¥‡∏Å', '‡∏£‡∏≤‡∏®‡∏µ‡∏û‡∏¥‡∏à‡∏¥‡∏Å'],
                'description': '‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏∂‡∏Å‡∏•‡∏±‡∏ö ‡∏°‡∏µ‡πÄ‡∏™‡∏ô‡πà‡∏´‡πå‡∏î‡∏∂‡∏á‡∏î‡∏π‡∏î ‡∏°‡∏∏‡πà‡∏á‡∏°‡∏±‡πà‡∏ô‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏±‡∏á ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏ó‡∏µ‡πà‡∏•‡∏∂‡∏Å‡∏ã‡∏∂‡πâ‡∏á'
            },
            'sagittarius': {
                'name': '‡∏ò‡∏ô‡∏π', 'element': '‡πÑ‡∏ü', 'quality': 'Mutable', 'keywords': ['‡∏ò‡∏ô‡∏π', '‡∏£‡∏≤‡∏®‡∏µ‡∏ò‡∏ô‡∏π'],
                'description': '‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏Å‡∏≠‡∏¥‡∏™‡∏£‡∏∞ ‡∏°‡∏≠‡∏á‡πÇ‡∏•‡∏Å‡πÉ‡∏ô‡πÅ‡∏á‡πà‡∏î‡∏µ ‡∏ä‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ú‡∏à‡∏ç‡∏†‡∏±‡∏¢ ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏ß‡∏á‡∏´‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á'
            },
            'capricorn': {
                'name': '‡∏°‡∏±‡∏á‡∏Å‡∏£', 'element': '‡∏î‡∏¥‡∏ô', 'quality': 'Cardinal', 'keywords': ['‡∏°‡∏±‡∏á‡∏Å‡∏£', '‡∏£‡∏≤‡∏®‡∏µ‡∏°‡∏±‡∏á‡∏Å‡∏£'],
                'description': '‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏∞‡πÄ‡∏¢‡∏≠‡∏ó‡∏∞‡∏¢‡∏≤‡∏ô ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏™‡∏π‡∏á ‡∏°‡∏µ‡∏ß‡∏¥‡∏ô‡∏±‡∏¢ ‡πÅ‡∏•‡∏∞‡∏°‡∏∏‡πà‡∏á‡∏°‡∏±‡πà‡∏ô‡∏™‡∏π‡πà‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'
            },
            'aquarius': {
                'name': '‡∏Å‡∏∏‡∏°‡∏†‡πå', 'element': '‡∏•‡∏°', 'quality': 'Fixed', 'keywords': ['‡∏Å‡∏∏‡∏°‡∏†‡πå', '‡∏£‡∏≤‡∏®‡∏µ‡∏Å‡∏∏‡∏°‡∏†‡πå'],
                'description': '‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á ‡∏£‡∏±‡∏Å‡∏≠‡∏¥‡∏™‡∏£‡∏∞ ‡∏°‡∏µ‡∏ß‡∏¥‡∏™‡∏±‡∏¢‡∏ó‡∏±‡∏®‡∏ô‡πå ‡πÅ‡∏•‡∏∞‡∏ä‡∏≠‡∏ö‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏™‡∏±‡∏á‡∏Ñ‡∏°'
            },
            'pisces': {
                'name': '‡∏°‡∏µ‡∏ô', 'element': '‡∏ô‡πâ‡∏≥', 'quality': 'Mutable', 'keywords': ['‡∏°‡∏µ‡∏ô', '‡∏£‡∏≤‡∏®‡∏µ‡∏°‡∏µ‡∏ô'],
                'description': '‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏à‡∏¥‡∏ô‡∏ï‡∏ô‡∏≤‡∏Å‡∏≤‡∏£‡∏™‡∏π‡∏á ‡πÄ‡∏´‡πá‡∏ô‡∏≠‡∏Å‡πÄ‡∏´‡πá‡∏ô‡πÉ‡∏à‡∏ú‡∏π‡πâ‡∏≠‡∏∑‡πà‡∏ô ‡∏°‡∏µ‡∏™‡∏±‡∏ç‡∏ä‡∏≤‡∏ï‡∏ç‡∏≤‡∏ì‡∏î‡∏µ ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô'
            }
        }
        
        # ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏®‡∏µ‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (‡πÉ‡∏ä‡πâ regex ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏≥‡πÄ‡∏ï‡πá‡∏°)
        for sign_key, sign_info in zodiac_data.items():
            for keyword in sign_info['keywords']:
                # ‡πÉ‡∏ä‡πâ regex ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏û‡∏ö‡∏Ñ‡∏≥‡πÄ‡∏ï‡πá‡∏°‡πÜ (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≥‡∏≠‡∏∑‡πà‡∏ô)
                # ‡πÄ‡∏ä‡πà‡∏ô "‡∏Å‡∏±‡∏ô‡∏¢‡πå" ‡πÑ‡∏°‡πà‡∏Ñ‡∏ß‡∏£ match ‡∏Å‡∏±‡∏ö "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô"
                pattern = r'\b' + re.escape(keyword) + r'\b'
                if re.search(pattern, text_lower):
                    logger.info(f"‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏®‡∏µ‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°: {sign_info['name']} (keyword: {keyword})")
                    return {
                        'sign': sign_info['name'],
                        'element': sign_info['element'],
                        'quality': sign_info['quality'],
                        'english_name': sign_key.title(),
                        'description': sign_info['description']
                    }
        
        return None

    def calculate_chinese_zodiac(self, year: int) -> dict:
        """
        ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏õ‡∏µ‡∏ô‡∏±‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏à‡∏≤‡∏Å‡∏õ‡∏µ ‡∏Ñ.‡∏®.
        
        Args:
            year (int): ‡∏õ‡∏µ ‡∏Ñ.‡∏®.
            
        Returns:
            dict: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏µ‡∏ô‡∏±‡∏Å‡∏©‡∏±‡∏ï‡∏£ {'sign': '‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏µ‡∏ô‡∏±‡∏Å‡∏©‡∏±‡∏ï‡∏£', 'english_name': '‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©', 'element': '‡∏ò‡∏≤‡∏ï‡∏∏ (‡∏ï‡∏≤‡∏°‡∏õ‡∏µ)'}
        """
        animals = [
            {'name': '‡∏ä‡∏ß‡∏î', 'eng': 'Rat', 'element': 'Water'},
            {'name': '‡∏â‡∏•‡∏π', 'eng': 'Ox', 'element': 'Earth'},
            {'name': '‡∏Ç‡∏≤‡∏•', 'eng': 'Tiger', 'element': 'Wood'},
            {'name': '‡πÄ‡∏ñ‡∏≤‡∏∞', 'eng': 'Rabbit', 'element': 'Wood'},
            {'name': '‡∏°‡∏∞‡πÇ‡∏£‡∏á', 'eng': 'Dragon', 'element': 'Earth'},
            {'name': '‡∏°‡∏∞‡πÄ‡∏™‡πá‡∏á', 'eng': 'Snake', 'element': 'Fire'},
            {'name': '‡∏°‡∏∞‡πÄ‡∏°‡∏µ‡∏¢', 'eng': 'Horse', 'element': 'Fire'},
            {'name': '‡∏°‡∏∞‡πÅ‡∏°', 'eng': 'Goat', 'element': 'Earth'},
            {'name': '‡∏ß‡∏≠‡∏Å', 'eng': 'Monkey', 'element': 'Metal'},
            {'name': '‡∏£‡∏∞‡∏Å‡∏≤', 'eng': 'Rooster', 'element': 'Metal'},
            {'name': '‡∏à‡∏≠', 'eng': 'Dog', 'element': 'Earth'},
            {'name': '‡∏Å‡∏∏‡∏ô', 'eng': 'Pig', 'element': 'Water'}
        ]
        
        index = (year - 4) % 12
        animal = animals[index]
        
        return {
            'sign': f"‡∏õ‡∏µ{animal['name']}",
            'animal_name': animal['name'],
            'english_name': animal['eng'],
            'element': animal['element']
        }

    def get_lucky_colors(self, zodiac_sign: str) -> dict:
        """
        ‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏µ‡∏°‡∏á‡∏Ñ‡∏•‡∏ï‡∏≤‡∏°‡∏£‡∏≤‡∏®‡∏µ (Western Astrology)
        
        Args:
            zodiac_sign (str): ‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏®‡∏µ (‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢)
            
        Returns:
            dict: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏µ‡∏°‡∏á‡∏Ñ‡∏• {'primary': '‡∏™‡∏µ‡∏´‡∏•‡∏±‡∏Å', 'secondary': '‡∏™‡∏µ‡∏£‡∏≠‡∏á', 'avoid': '‡∏™‡∏µ‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á'}
        """
        colors_map = {
            '‡πÄ‡∏°‡∏©': {'primary': '‡πÅ‡∏î‡∏á', 'secondary': '‡∏Ç‡∏≤‡∏ß, ‡∏ä‡∏°‡∏û‡∏π', 'avoid': '‡∏î‡∏≥'},
            '‡∏û‡∏§‡∏©‡∏†': {'primary': '‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß', 'secondary': '‡∏ä‡∏°‡∏û‡∏π, ‡∏ü‡πâ‡∏≤', 'avoid': '‡πÅ‡∏î‡∏á'},
            '‡πÄ‡∏°‡∏ñ‡∏∏‡∏ô': {'primary': '‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á', 'secondary': '‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß, ‡∏™‡πâ‡∏°', 'avoid': '‡πÄ‡∏ó‡∏≤'},
            '‡∏Å‡∏£‡∏Å‡∏é': {'primary': '‡∏Ç‡∏≤‡∏ß', 'secondary': '‡πÄ‡∏á‡∏¥‡∏ô, ‡∏Ñ‡∏£‡∏µ‡∏°', 'avoid': '‡∏î‡∏≥'},
            '‡∏™‡∏¥‡∏á‡∏´‡πå': {'primary': '‡∏ó‡∏≠‡∏á', 'secondary': '‡∏™‡πâ‡∏°, ‡πÅ‡∏î‡∏á', 'avoid': '‡∏ü‡πâ‡∏≤'},
            '‡∏Å‡∏±‡∏ô‡∏¢‡πå': {'primary': '‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß', 'secondary': '‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•, ‡πÄ‡∏ó‡∏≤', 'avoid': '‡πÅ‡∏î‡∏á'},
            '‡∏ï‡∏∏‡∏•': {'primary': '‡∏ü‡πâ‡∏≤', 'secondary': '‡∏ä‡∏°‡∏û‡∏π, ‡∏Ç‡∏≤‡∏ß', 'avoid': '‡∏™‡πâ‡∏°'},
            '‡∏û‡∏¥‡∏à‡∏¥‡∏Å': {'primary': '‡πÅ‡∏î‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏´‡∏°‡∏π', 'secondary': '‡∏î‡∏≥, ‡∏°‡πà‡∏ß‡∏á', 'avoid': '‡∏ü‡πâ‡∏≤'},
            '‡∏ò‡∏ô‡∏π': {'primary': '‡∏°‡πà‡∏ß‡∏á', 'secondary': '‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô, ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á', 'avoid': '‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß'},
            '‡∏°‡∏±‡∏á‡∏Å‡∏£': {'primary': '‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•', 'secondary': '‡πÄ‡∏ó‡∏≤, ‡∏î‡∏≥', 'avoid': '‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á'},
            '‡∏Å‡∏∏‡∏°‡∏†‡πå': {'primary': '‡∏ü‡πâ‡∏≤', 'secondary': '‡∏°‡πà‡∏ß‡∏á, ‡πÄ‡∏á‡∏¥‡∏ô', 'avoid': '‡∏ó‡∏≠‡∏á'},
            '‡∏°‡∏µ‡∏ô': {'primary': '‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏ó‡∏∞‡πÄ‡∏•', 'secondary': '‡∏°‡πà‡∏ß‡∏á, ‡∏ü‡πâ‡∏≤', 'avoid': '‡πÅ‡∏î‡∏á'}
        }
        
        # Clean zodiac name just in case
        clean_sign = zodiac_sign.replace('‡∏£‡∏≤‡∏®‡∏µ', '').strip()
        return colors_map.get(clean_sign, {'primary': '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏', 'secondary': '', 'avoid': ''})

    def calculate_zodiac_sign(self, day: int, month: int) -> dict:
        """
        ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏®‡∏µ‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (Western Astrology)
        
        Args:
            day (int): ‡∏ß‡∏±‡∏ô
            month (int): ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
            
        Returns:
            dict: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏®‡∏µ {'sign': '‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏®‡∏µ', 'element': '‡∏ò‡∏≤‡∏ï‡∏∏', 'quality': '‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û'}
        """
        # ‡∏£‡∏≤‡∏®‡∏µ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        zodiac_data = {
            'aries': {
                'name': '‡πÄ‡∏°‡∏©', 'element': '‡πÑ‡∏ü', 'quality': 'Cardinal', 'dates': [(3, 21), (4, 19)],
                'description': '‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡πÄ‡∏ï‡πá‡∏°‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏£‡∏∞‡∏ï‡∏∑‡∏≠‡∏£‡∏∑‡∏≠‡∏•‡πâ‡∏ô ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏ô‡∏≥ ‡∏Å‡∏•‡πâ‡∏≤‡∏´‡∏≤‡∏ç‡πÅ‡∏•‡∏∞‡∏ä‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô'
            },
            'taurus': {
                'name': '‡∏û‡∏§‡∏©‡∏†', 'element': '‡∏î‡∏¥‡∏ô', 'quality': 'Fixed', 'dates': [(4, 20), (5, 20)],
                'description': '‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏î‡∏ó‡∏ô ‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á ‡∏£‡∏±‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏á‡∏ö ‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏ô‡∏ä‡∏≠‡∏ö‡πÉ‡∏ô‡∏™‡∏∏‡∏ô‡∏ó‡∏£‡∏µ‡∏¢‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏á‡∏≤‡∏°'
            },
            'gemini': {
                'name': '‡πÄ‡∏°‡∏ñ‡∏∏‡∏ô', 'element': '‡∏•‡∏°', 'quality': 'Mutable', 'dates': [(5, 21), (6, 20)],
                'description': '‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£ ‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏Å‡πà‡∏á ‡∏≠‡∏¢‡∏≤‡∏Å‡∏£‡∏π‡πâ‡∏≠‡∏¢‡∏≤‡∏Å‡πÄ‡∏´‡πá‡∏ô ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏£‡∏£‡∏Ñ‡πå'
            },
            'cancer': {
                'name': '‡∏Å‡∏£‡∏Å‡∏é', 'element': '‡∏ô‡πâ‡∏≥', 'quality': 'Cardinal', 'dates': [(6, 21), (7, 22)],
                'description': '‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡πà‡∏≠‡∏ô‡πÇ‡∏¢‡∏ô ‡∏£‡∏±‡∏Å‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß ‡∏°‡∏µ‡∏™‡∏±‡∏ç‡∏ä‡∏≤‡∏ï‡∏ç‡∏≤‡∏ì‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏Å‡∏õ‡πâ‡∏≠‡∏á‡∏î‡∏π‡πÅ‡∏• ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡πÑ‡∏ß'
            },
            'leo': {
                'name': '‡∏™‡∏¥‡∏á‡∏´‡πå', 'element': '‡πÑ‡∏ü', 'quality': 'Fixed', 'dates': [(7, 23), (8, 22)],
                'description': '‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à ‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏ô‡∏≥‡πÇ‡∏î‡∏¢‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥ ‡πÉ‡∏à‡∏Å‡∏ß‡πâ‡∏≤‡∏á ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏£‡∏£‡∏Ñ‡πå'
            },
            'virgo': {
                'name': '‡∏Å‡∏±‡∏ô‡∏¢‡πå', 'element': '‡∏î‡∏¥‡∏ô', 'quality': 'Mutable', 'dates': [(8, 23), (9, 22)],
                'description': '‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏£‡∏≠‡∏ö‡∏Ñ‡∏≠‡∏ö ‡∏°‡∏µ‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö‡∏ß‡∏¥‡∏ô‡∏±‡∏¢ ‡∏ä‡πà‡∏≤‡∏á‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï ‡πÅ‡∏•‡∏∞‡πÉ‡∏™‡πà‡πÉ‡∏à‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î'
            },
            'libra': {
                'name': '‡∏ï‡∏∏‡∏•', 'element': '‡∏•‡∏°', 'quality': 'Cardinal', 'dates': [(9, 23), (10, 22)],
                'description': '‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏∏‡∏ï‡∏¥‡∏ò‡∏£‡∏£‡∏° ‡∏°‡∏µ‡πÄ‡∏™‡∏ô‡πà‡∏´‡πå ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡πÄ‡∏Å‡πà‡∏á ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏ß‡∏á‡∏´‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏°‡∏î‡∏∏‡∏•‡πÉ‡∏ô‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï'
            },
            'scorpio': {
                'name': '‡∏û‡∏¥‡∏à‡∏¥‡∏Å', 'element': '‡∏ô‡πâ‡∏≥', 'quality': 'Fixed', 'dates': [(10, 23), (11, 21)],
                'description': '‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏∂‡∏Å‡∏•‡∏±‡∏ö ‡∏°‡∏µ‡πÄ‡∏™‡∏ô‡πà‡∏´‡πå‡∏î‡∏∂‡∏á‡∏î‡∏π‡∏î ‡∏°‡∏∏‡πà‡∏á‡∏°‡∏±‡πà‡∏ô‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏±‡∏á ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏ó‡∏µ‡πà‡∏•‡∏∂‡∏Å‡∏ã‡∏∂‡πâ‡∏á'
            },
            'sagittarius': {
                'name': '‡∏ò‡∏ô‡∏π', 'element': '‡πÑ‡∏ü', 'quality': 'Mutable', 'dates': [(11, 22), (12, 21)],
                'description': '‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏Å‡∏≠‡∏¥‡∏™‡∏£‡∏∞ ‡∏°‡∏≠‡∏á‡πÇ‡∏•‡∏Å‡πÉ‡∏ô‡πÅ‡∏á‡πà‡∏î‡∏µ ‡∏ä‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ú‡∏à‡∏ç‡∏†‡∏±‡∏¢ ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏ß‡∏á‡∏´‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á'
            },
            'capricorn': {
                'name': '‡∏°‡∏±‡∏á‡∏Å‡∏£', 'element': '‡∏î‡∏¥‡∏ô', 'quality': 'Cardinal', 'dates': [(12, 22), (1, 19)],
                'description': '‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏∞‡πÄ‡∏¢‡∏≠‡∏ó‡∏∞‡∏¢‡∏≤‡∏ô ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏™‡∏π‡∏á ‡∏°‡∏µ‡∏ß‡∏¥‡∏ô‡∏±‡∏¢ ‡πÅ‡∏•‡∏∞‡∏°‡∏∏‡πà‡∏á‡∏°‡∏±‡πà‡∏ô‡∏™‡∏π‡πà‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'
            },
            'aquarius': {
                'name': '‡∏Å‡∏∏‡∏°‡∏†‡πå', 'element': '‡∏•‡∏°', 'quality': 'Fixed', 'dates': [(1, 20), (2, 18)],
                'description': '‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á ‡∏£‡∏±‡∏Å‡∏≠‡∏¥‡∏™‡∏£‡∏∞ ‡∏°‡∏µ‡∏ß‡∏¥‡∏™‡∏±‡∏¢‡∏ó‡∏±‡∏®‡∏ô‡πå ‡πÅ‡∏•‡∏∞‡∏ä‡∏≠‡∏ö‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏™‡∏±‡∏á‡∏Ñ‡∏°'
            },
            'pisces': {
                'name': '‡∏°‡∏µ‡∏ô', 'element': '‡∏ô‡πâ‡∏≥', 'quality': 'Mutable', 'dates': [(2, 19), (3, 20)],
                'description': '‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏à‡∏¥‡∏ô‡∏ï‡∏ô‡∏≤‡∏Å‡∏≤‡∏£‡∏™‡∏π‡∏á ‡πÄ‡∏´‡πá‡∏ô‡∏≠‡∏Å‡πÄ‡∏´‡πá‡∏ô‡πÉ‡∏à‡∏ú‡∏π‡πâ‡∏≠‡∏∑‡πà‡∏ô ‡∏°‡∏µ‡∏™‡∏±‡∏ç‡∏ä‡∏≤‡∏ï‡∏ç‡∏≤‡∏ì‡∏î‡∏µ ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô'
            }
        }
        
        # ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏≤‡∏®‡∏µ
        for sign_key, sign_info in zodiac_data.items():
            start_month, start_day = sign_info['dates'][0]
            end_month, end_day = sign_info['dates'][1]
            
            # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏≤‡∏®‡∏µ‡∏°‡∏±‡∏á‡∏Å‡∏£ (‡∏Ç‡πâ‡∏≤‡∏°‡∏õ‡∏µ)
            if sign_key == 'capricorn':
                if (month == 12 and day >= start_day) or (month == 1 and day <= end_day):
                    logger.info(f"Matched Capricorn: day={day}, month={month}")
                    return {
                        'sign': sign_info['name'],
                        'element': sign_info['element'],
                        'quality': sign_info['quality'],
                        'english_name': sign_key.title(),
                        'description': sign_info['description']
                    }
            else:
                if (month == start_month and day >= start_day) or (month == end_month and day <= end_day):
                    logger.info(f"Matched {sign_key}: day={day}, month={month}, range={start_month}/{start_day}-{end_month}/{end_day}")
                    return {
                        'sign': sign_info['name'],
                        'element': sign_info['element'],
                        'quality': sign_info['quality'],
                        'english_name': sign_key.title(),
                        'description': sign_info['description']
                    }
        
        logger.warning(f"No zodiac match found for day={day}, month={month}")
        return None

    def generate_birth_chart_info(self, birth_date: str, birth_time: str = None, latitude: float = 13.7563, longitude: float = 100.5018) -> dict:
        """
        ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏ß‡∏á‡∏ä‡∏∞‡∏ï‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô ‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Ascendant
        
        Args:
            birth_date (str): ‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö dd/mm/yyyy
            birth_time (str): ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Å‡∏¥‡∏î‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö HH:MM (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)
            latitude (float): ‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î‡∏Ç‡∏≠‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î (default: ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø)
            longitude (float): ‡∏•‡∏≠‡∏á‡∏à‡∏¥‡∏à‡∏π‡∏î‡∏Ç‡∏≠‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î (default: ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø)
            
        Returns:
            dict: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏ß‡∏á‡∏ä‡∏∞‡∏ï‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
        """
        if not birth_date:
            return None

        logger.info(f"[DEBUG] generate_birth_chart_info called with: date={birth_date}, time={birth_time}, lat={latitude}, lon={longitude}")
        
        try:
            # ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î
            day, month, year = map(int, birth_date.split('/'))
            
            # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏®‡∏µ
            zodiac_info = self.calculate_zodiac_sign(day, month)
            logger.info(f"Calculated zodiac for {day}/{month}: {zodiac_info}")
            
            if not zodiac_info:
                logger.error(f"Failed to calculate zodiac for {day}/{month}")
                return None
            
            # ‡∏™‡∏£‡πâ‡∏≤‡∏á birth_datetime
            birth_datetime = datetime(year, month, day)
            
            # ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Å‡∏¥‡∏î ‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô birth_datetime
            if birth_time:
                try:
                    hour, minute = map(int, birth_time.split(':'))
                    birth_datetime = birth_datetime.replace(hour=hour, minute=minute)
                except:
                    logger.warning(f"Invalid birth time format: {birth_time}")
            
            # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏≤‡∏¢‡∏∏
            age = datetime.now().year - year
            
            # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏õ‡∏µ‡∏ô‡∏±‡∏Å‡∏©‡∏±‡∏ï‡∏£ (Chinese Zodiac)
            chinese_zodiac_info = self.calculate_chinese_zodiac(year)
            
            # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏µ‡∏°‡∏á‡∏Ñ‡∏•
            lucky_colors = self.get_lucky_colors(zodiac_info['sign'])
            
            # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏ß‡∏á‡∏ä‡∏∞‡∏ï‡∏≤
            chart_info = {
                'birth_date': birth_date,
                'birth_time': birth_time,
                'age': age,
                'zodiac_sign': zodiac_info['sign'],
                'zodiac_element': zodiac_info['element'],
                'zodiac_quality': zodiac_info['quality'],
                'zodiac_english': zodiac_info['english_name'],
                'zodiac_description': zodiac_info.get('description', ''),
                'chinese_zodiac': chinese_zodiac_info['sign'],
                'chinese_zodiac_animal': chinese_zodiac_info['animal_name'],
                'chinese_zodiac_english': chinese_zodiac_info['english_name'],
                'lucky_colors': lucky_colors,
                'birth_datetime': birth_datetime,
                'birth_location': {
                    'latitude': latitude,
                    'longitude': longitude
                }
            }
            
            # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Ascendant ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Å‡∏¥‡∏î
            if birth_time:
                try:
                    ascendant_data = self.astronomical_calculator.calculate_ascendant(
                        birth_datetime, latitude, longitude
                    )
                    if ascendant_data:
                        chart_info['ascendant'] = ascendant_data
                        chart_info['ascendant_interpretation'] = self.astronomical_calculator.get_ascendant_interpretation(ascendant_data)
                        logger.info(f"‚úÖ Calculated Ascendant: {ascendant_data['sign']} {ascendant_data['degree']:.1f}¬∞")
                    else:
                        logger.warning("Failed to calculate Ascendant")
                except Exception as e:
                    logger.error(f"Error calculating Ascendant: {e}")
            
            # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ö‡πâ‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á 12 ‡∏ö‡πâ‡∏≤‡∏ô ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Å‡∏¥‡∏î
            if birth_time:
                try:
                    houses_data = self.astronomical_calculator.calculate_house_cusps(
                        birth_datetime, latitude, longitude
                    )
                    if houses_data:
                        chart_info['houses'] = houses_data
                        logger.info(f"‚úÖ Calculated 12 houses")
                    else:
                        logger.warning("Failed to calculate houses")
                except Exception as e:
                    logger.error(f"Error calculating houses: {e}")

            # üÜï ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏î‡∏≤‡∏ß‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå (Planets) - ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏™‡∏°‡∏≠‡πÅ‡∏°‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Å‡∏¥‡∏î (‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏ ‡πÅ‡∏ï‡πà‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ birth_datetime ‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡πÄ‡∏™‡∏°‡∏≠)
            try:
                planets_data = self.astronomical_calculator.calculate_planetary_positions(
                    birth_datetime, latitude, longitude
                )
                if planets_data:
                    chart_info['planets'] = planets_data['planets']
                    logger.info(f"‚úÖ Calculated planetary positions: {len(planets_data['planets'])} planets")
                    
                    # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏°‡∏∏‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå (Aspects)
                    aspects_data = self.astronomical_calculator.calculate_aspects(planets_data)
                    if aspects_data:
                        chart_info['aspects'] = aspects_data
                        logger.info(f"‚úÖ Calculated aspects: {len(aspects_data)} aspects")
                    
            except Exception as e:
                logger.error(f"Error calculating planets/aspects: {e}")
            
            return chart_info
            
        except Exception as e:
            logger.error(f"Error generating birth chart: {e}")
            return None

    def test_parser(self):
        """‡∏ó‡∏î‡∏™‡∏≠‡∏ö parser ‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ï‡πà‡∏≤‡∏á‡πÜ"""
        test_cases = [
            "07/09/2003",
            "7-9-2003",
            "7.9.2003",
            "2003/09/07",
            "7 9 2003",
            "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 7 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô 9 ‡∏õ‡∏µ 2003",
            "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà7‡πÄ‡∏î‡∏∑‡∏≠‡∏ô9‡∏õ‡∏µ2003",
            "‡πÄ‡∏Å‡∏¥‡∏î‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 7/9/2003",
            "‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô‡∏Ñ‡∏∑‡∏≠ 07/09/2003",
            "7 ‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏° 2003",
            "7 ‡∏°.‡∏Ñ. 2003",
            "7 January 2003",
            "7 Jan 2003",
            "07092003",
            "7/9/2546",  # ‡∏õ‡∏µ ‡∏û.‡∏®.
            "‡πÄ‡∏Å‡∏¥‡∏î 15 ‡∏û.‡∏Ñ. 90",
            "15/05/90",
            "‡∏â‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 25 ‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏° 1985",
            "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö ‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡∏ú‡∏°‡∏Ñ‡∏∑‡∏≠ 15/03/1990 ‡∏Ñ‡∏£‡∏±‡∏ö",
            "Hello my birthday is 15/03/1990",
            "07/09/2003‡∏£‡∏≤‡∏®‡∏µ‡∏≠‡∏∞‡πÑ‡∏£",  # üÜï ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏¥‡∏î‡∏Å‡∏±‡∏ô
            "15/03/1990‡∏£‡∏≤‡∏®‡∏µ‡∏≠‡∏∞‡πÑ‡∏£",
            "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏µ‡πâ",
            # üÜï ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Å‡∏¥‡∏î
            "‡πÄ‡∏Å‡∏¥‡∏î‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 7/9/2003 ‡πÄ‡∏ß‡∏•‡∏≤ 14:30",
            "‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î 15/03/1990 ‡πÄ‡∏ß‡∏•‡∏≤ 2 ‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤ 30 ‡∏ô‡∏≤‡∏ó‡∏µ",
            "‡πÄ‡∏Å‡∏¥‡∏î 25/12/1985 ‡πÄ‡∏ß‡∏•‡∏≤ 8.30",
            "7/9/2003 14:30 ‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏î‡∏ß‡∏á‡∏ä‡∏∞‡∏ï‡∏≤",
            # üÜï ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î
            "‡πÄ‡∏Å‡∏¥‡∏î‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 7/9/2003 ‡πÄ‡∏ß‡∏•‡∏≤ 14:30 ‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà",
            "‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î 15/03/1990 ‡πÄ‡∏ß‡∏•‡∏≤ 2 ‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤ 30 ‡∏ô‡∏≤‡∏ó‡∏µ ‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï",
            "‡πÄ‡∏Å‡∏¥‡∏î 25/12/1985 ‡πÄ‡∏ß‡∏•‡∏≤ 8.30 ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø",
            "7/9/2003 14:30 ‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà ‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏î‡∏ß‡∏á‡∏ä‡∏∞‡∏ï‡∏≤"
        ]
        
        print("üß™ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Birth Date Parser")
        print("=" * 50)
        
        for i, test in enumerate(test_cases, 1):
            result = self.extract_birth_date(test)
            time_result = self.extract_birth_time(test)
            location_result = self.extract_birth_location(test)
            status = "‚úÖ" if result else "‚ùå"
            time_status = "‚è∞" if time_result else "‚è∏Ô∏è"
            location_status = "üìç" if location_result['location'] != '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø' else "üè†"
            print(f"{i:2d}. {status} {time_status} {location_status} '{test}' ‚Üí Date: {result}, Time: {time_result}, Location: {location_result['location']}")
            
            # ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏î‡∏ß‡∏á‡∏ä‡∏∞‡∏ï‡∏≤
            if result:
                birth_info = self.generate_birth_chart_info(result, time_result, location_result['latitude'], location_result['longitude'])
                if birth_info:
                    print(f"    üåü ‡∏£‡∏≤‡∏®‡∏µ: {birth_info['zodiac_sign']} ({birth_info['zodiac_element']})")
                    if 'birth_location_name' in birth_info:
                        print(f"    üìç ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î: {birth_info['birth_location_name']}")
                    
                    # ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Ascendant ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
                    if 'ascendant' in birth_info:
                        ascendant = birth_info['ascendant']
                        print(f"    üåÖ Ascendant: ‡∏£‡∏≤‡∏®‡∏µ{ascendant['sign']} {ascendant['degree']:.1f}¬∞ ({ascendant['element']})")
                        print(f"    üìù ‡∏Å‡∏≤‡∏£‡∏ï‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°: {birth_info.get('ascendant_interpretation', '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•')}")
                    
                    # ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡πâ‡∏≤‡∏ô‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
                    if 'houses' in birth_info:
                        print(f"    üè† ‡∏ö‡πâ‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á 12 ‡∏ö‡πâ‡∏≤‡∏ô: ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏•‡πâ‡∏ß")
                        # ‡πÅ‡∏™‡∏î‡∏á‡∏ö‡πâ‡∏≤‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç
                        important_houses = [1, 4, 7, 10]  # Ascendant, IC, Descendant, MC
                        for house_num in important_houses:
                            house_data = birth_info['houses'].get(f'house_{house_num}')
                            if house_data:
                                print(f"       ‡∏ö‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà {house_num}: ‡∏£‡∏≤‡∏®‡∏µ{house_data['sign']} {house_data['degree']:.1f}¬∞")
                print()

# ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡πÉ‡∏ô response_message.py
def detect_zodiac_sign_in_message(message: str) -> dict:
    """
    ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏á‡πà‡∏≤‡∏¢‡πÜ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏®‡∏µ‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
    
    Args:
        message (str): ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
        
    Returns:
        dict: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏®‡∏µ‡∏ó‡∏µ‡πà‡∏û‡∏ö ‡∏´‡∏£‡∏∑‡∏≠ None
    """
    parser = BirthDateParser()
    return parser.detect_zodiac_sign_in_message(message)

def extract_birth_date_from_message(message: str) -> str:
    """
    ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏á‡πà‡∏≤‡∏¢‡πÜ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏¢‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
    
    Args:
        message (str): ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
        
    Returns:
        str: ‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö dd/mm/yyyy ‡∏´‡∏£‡∏∑‡∏≠ None
    """
    parser = BirthDateParser()
    return parser.extract_birth_date(message)

def extract_birth_info_from_message(message: str) -> dict:
    """
    ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏¢‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Å‡∏¥‡∏î ‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
    
    Args:
        message (str): ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
        
    Returns:
        dict: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Å‡∏¥‡∏î ‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î
    """
    parser = BirthDateParser()
    return parser.extract_birth_info(message)

def get_zodiac_data_from_mongodb(zodiac_sign: str) -> dict:
    """
    ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏®‡∏µ‡∏à‡∏≤‡∏Å MongoDB
    
    Args:
        zodiac_sign (str): ‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏®‡∏µ
        
    Returns:
        dict: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏®‡∏µ
    """
    try:
        mongo_uri = os.getenv("MONGO_URL")
        if not mongo_uri or mongo_uri == "mongodb+srv://your-username:your-password@cluster0.xxxxx.mongodb.net/?retryWrites=true&w=majority":
            logger.warning("MONGO_URL not configured properly")
            return None
            
        client = MongoClient(mongo_uri, serverSelectionTimeoutMS=5000, connectTimeoutMS=5000)
        db = client["astrobot"]
        collection = db["zodiac_personality"]
        
        # ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏®‡∏µ
        zodiac_data = collection.find_one({"zodiac_sign": zodiac_sign})
        try:
            if zodiac_data:
                logger.info(
                    f"üìö MongoDB source used for answer -> collection='zodiac_personality', _id={zodiac_data.get('_id')}, zodiac_sign={zodiac_sign}"
                )
            else:
                logger.info(
                    f"üìö MongoDB lookup -> collection='zodiac_personality', zodiac_sign={zodiac_sign}, result=None"
                )
        except Exception:
            pass
        client.close()
        
        if zodiac_data:
            # ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏°
            return {
                "‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏ô‡∏¥‡∏™‡∏±‡∏¢": zodiac_data.get("personality_traits", ""),
                "‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô": zodiac_data.get("career", ""),
                "‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô": zodiac_data.get("finance", ""),
                "‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û": zodiac_data.get("health", ""),
                "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏Å": zodiac_data.get("love", {})
            }
        else:
            logger.warning(f"No data found for zodiac sign: {zodiac_sign}")
            return None
            
    except Exception as e:
        logger.error(f"Error fetching zodiac data from MongoDB: {e}")
        return None

def generate_astrology_reading(message: str) -> dict:
    """
    ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏î‡∏ß‡∏á‡∏ä‡∏∞‡∏ï‡∏≤‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
    
    Args:
        message (str): ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
        
    Returns:
        dict: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏ß‡∏á‡∏ä‡∏∞‡∏ï‡∏≤‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢
    """
    parser = BirthDateParser()
    birth_info = parser.extract_birth_info(message)
    
    if not birth_info or not birth_info['date']:
        return None
    
    # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏ß‡∏á‡∏ä‡∏∞‡∏ï‡∏≤
    chart_info = parser.generate_birth_chart_info(birth_info['date'], birth_info['time'])
    
    if not chart_info:
        return None
    
    return chart_info


def generate_detailed_astrology_reading(message: str, latitude: float = None, longitude: float = None) -> dict:
    """
    ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏î‡∏ß‡∏á‡∏ä‡∏∞‡∏ï‡∏≤‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÉ‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô ‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏Å
    
    Args:
        message (str): ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
        latitude (float): ‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î‡∏Ç‡∏≠‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°)
        longitude (float): ‡∏•‡∏≠‡∏á‡∏à‡∏¥‡∏à‡∏π‡∏î‡∏Ç‡∏≠‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°)
        
    Returns:
        dict: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏ß‡∏á‡∏ä‡∏∞‡∏ï‡∏≤‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
    """
    import json
    import os
    
    parser = BirthDateParser()
    birth_info = parser.extract_birth_info(message)
    
    if not birth_info or not birth_info['date']:
        return None
    
    # ‡πÉ‡∏ä‡πâ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤
    if latitude is None:
        latitude = birth_info.get('latitude', 13.7563)
    if longitude is None:
        longitude = birth_info.get('longitude', 100.5018)
    
    logger.info(f"[DEBUG] generate_detailed_astrology_reading: Lat={latitude}, Lon={longitude}")
    
    # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏ß‡∏á‡∏ä‡∏∞‡∏ï‡∏≤
    # Use keyword explicitly to avoid position errors
    chart_info = parser.generate_birth_chart_info(
        birth_date=birth_info['date'], 
        birth_time=birth_info['time'], 
        latitude=latitude, 
        longitude=longitude
    )
    
    if not chart_info:
        return None
    
    # ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î
    chart_info['birth_location_name'] = birth_info.get('location', '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø')
    
    # ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏´‡∏£‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
    zodiac_sign = chart_info['zodiac_sign']
    
    # DISABLE JSON FALLBACKS AND MONGODB "ZODIAC_PERSONALITY" LOOKUP
    # As per user request, we must rely ONLY on the retrieved chunks from "astrobot_original" (Book Data).
    # Therefore, we do NOT load any pre-canned data here.
    
    # zodiac_data = get_zodiac_data_from_mongodb(zodiac_sign) ... (Disabled)
    # chart_info['detailed_reading'] = ... (Disabled)
    # lucky_color_data = ... (Disabled)
    # omen_data = ... (Disabled)
    
    # Initialize empty structures to prevent errors if downstream code expects keys
    chart_info['detailed_reading'] = {} 
    chart_info['lucky_colors'] = []
    chart_info['bad_colors'] = []
    chart_info['omen_info'] = {}

    logger.info(f"‚úÖ Created birth chart for {zodiac_sign} (Pure RAG Mode - No external data injected)")
    
    return chart_info

def generate_birth_chart_prediction(message: str, user_id: str = "unknown") -> str:
    """
    ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏î‡∏ß‡∏á‡∏Å‡∏≥‡πÄ‡∏ô‡∏¥‡∏î‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ RAG system (‡πÉ‡∏ä‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î)
    
    Args:
        message (str): ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î
        user_id (str): ID ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
        
    Returns:
        str: ‡∏Ñ‡∏≥‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏î‡∏ß‡∏á‡∏Å‡∏≥‡πÄ‡∏ô‡∏¥‡∏î‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏à‡∏≤‡∏Å RAG
    """
    parser = BirthDateParser()
    birth_info = parser.extract_birth_info(message)
    
    if not birth_info or not birth_info['date']:
        return "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏¢‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô"
    
    # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏ß‡∏á‡∏ä‡∏∞‡∏ï‡∏≤ (‡∏£‡∏ß‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Å‡∏¥‡∏î‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
    chart_info = parser.generate_birth_chart_info(
        birth_info['date'], 
        birth_info.get('time'), 
        birth_info.get('latitude', 13.7563), 
        birth_info.get('longitude', 100.5018)
    )
    
    if not chart_info:
        return "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏ß‡∏á‡∏ä‡∏∞‡∏ï‡∏≤‡πÑ‡∏î‡πâ"
    
    # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö RAG system
    enhanced_query = create_birth_chart_query(chart_info, birth_info)
    
    # ‡πÉ‡∏ä‡πâ RAG system ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢
    try:
        from .retrieval_utils import ask_question_to_rag
        prediction = ask_question_to_rag(enhanced_query, user_id, provided_chart_info=chart_info)
        
        # ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Ascendant ‡πÉ‡∏ô‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ñ‡πâ‡∏≤‡∏°‡∏µ ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
        if 'ascendant' in chart_info and prediction:
            # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            is_error_message = (
                prediction.startswith("‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡πà‡∏∞ ‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•") or
                prediction.startswith("‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡πà‡∏∞ ‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏£‡∏¥‡∏ö‡∏ó") or
                prediction.startswith("‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡πà‡∏∞ ‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏®‡∏µ") or
                prediction.startswith("‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö")  # ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°
            )
            
            if not is_error_message:
                ascendant = chart_info['ascendant']
                ascendant_info = f"""

üåü **‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏±‡∏Ñ‡∏ì‡∏≤ (Ascendant)**
‡∏£‡∏≤‡∏®‡∏µ‡∏•‡∏±‡∏Ñ‡∏ì‡∏≤: {ascendant['sign']} {ascendant['degree']:.1f}¬∞
‡∏ò‡∏≤‡∏ï‡∏∏: {ascendant['element']}
‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û: {ascendant['quality']}

{chart_info.get('ascendant_interpretation', '')}"""
                
                # ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏±‡∏Ñ‡∏ì‡∏≤‡πÉ‡∏ô‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö
                prediction += ascendant_info
                
                logger.info(f"‚úÖ Added Ascendant info to response: {ascendant['sign']} {ascendant['degree']:.1f}¬∞")
            else:
                logger.info("‚ö†Ô∏è Skipped adding Ascendant info due to error message")

        # üÜï Safety fallback ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ö‡∏ô‡∏™‡∏∏‡∏î:
        #    - ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏à‡∏£‡∏¥‡∏á (LINE) ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏¢‡∏±‡∏á‡∏™‡∏±‡πâ‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö 4 ‡∏î‡πâ‡∏≤‡∏ô ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ï‡∏≤‡∏° format ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
        #    - ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô RAGAS (user_id ‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ 'eval_') ‡∏õ‡∏¥‡∏î fallback ‡∏ô‡∏µ‡πâ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏µ‡πâ‡∏¢‡∏ô‡∏à‡∏≤‡∏Å‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏à‡∏£‡∏¥‡∏á
        is_ragas_eval = isinstance(user_id, str) and user_id.startswith("eval_")
        if not is_ragas_eval:
            try:
                aspect_keywords = ["‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô", "‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô", "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏Å", "‡∏™‡∏µ‡∏°‡∏á‡∏Ñ‡∏•"]
                pred_text = prediction or ""
                missing_aspects = [kw for kw in aspect_keywords if kw not in pred_text]
                pred_len = len(pred_text)
                
                if pred_len < 200 or missing_aspects:
                    zodiac_sign = chart_info.get("zodiac_sign", "")
                    zodiac_element = chart_info.get("zodiac_element", "")
                    birth_date_str = birth_info.get("date", "")
                    
                    logger.warning(
                        f"Prediction too short or missing aspects (len={pred_len}, missing={missing_aspects}) "
                        f"-> using deterministic fallback format for zodiac {zodiac_sign}"
                    )
                    
                    header = ""
                    if birth_date_str:
                        header = (
                            f"‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î: {birth_date_str}\n"
                            f"‡∏£‡∏≤‡∏®‡∏µ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ ‡∏£‡∏≤‡∏®‡∏µ{zodiac_sign}\n\n"
                        )
                    
                    body = (
                        f"‡∏ï‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏£‡∏≤‡∏®‡∏µ{zodiac_sign} ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏®‡∏µ‡∏ò‡∏≤‡∏ï‡∏∏{zodiac_element} ‡∏ã‡∏∂‡πà‡∏á‡∏°‡∏µ‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡πÄ‡∏î‡πà‡∏ô‡∏Ñ‡∏∑‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏£‡∏≠‡∏ö‡∏Ñ‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏•‡∏∂‡∏Å‡∏ã‡∏∂‡πâ‡∏á "
                        f"‡πÉ‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô ‡∏£‡∏≤‡∏®‡∏µ{zodiac_sign}‡∏°‡∏±‡∏Å‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏î‡∏µ‡πÉ‡∏ô‡∏™‡∏†‡∏≤‡∏û‡πÅ‡∏ß‡∏î‡∏•‡πâ‡∏≠‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏î‡∏µ ‡πÄ‡∏ä‡πà‡∏ô ‡∏á‡∏≤‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô ‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤\n\n"
                        f"‡πÉ‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô ‡∏£‡∏≤‡∏®‡∏µ{zodiac_sign}‡∏°‡∏µ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏°‡∏µ‡∏ê‡∏≤‡∏ô‡∏∞‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏î‡∏ß‡∏á‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏ê‡∏≤‡∏ô‡∏∞‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏®‡∏µ{zodiac_sign} ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏°‡πÑ‡∏î‡πâ‡∏î‡∏µ "
                        f"‡∏ô‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ô‡∏µ‡πâ ‡∏î‡∏≤‡∏ß‡∏®‡∏∏‡∏Å‡∏£‡πå‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏≠‡∏¥‡∏ó‡∏ò‡∏¥‡∏û‡∏•‡∏ï‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏≠‡∏≠‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡∏ã‡∏∂‡πà‡∏á‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏ß‡πà‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏î‡∏µ‡πÅ‡∏•‡∏∞‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏á‡∏Ñ‡∏±‡πà‡∏á‡πÑ‡∏î‡πâ\n\n"
                        f"‡πÉ‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏Å ‡∏£‡∏≤‡∏®‡∏µ{zodiac_sign}‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡∏î‡∏π‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÑ‡∏î‡πâ‡∏¢‡∏≤‡∏Å ‡πÅ‡∏ï‡πà‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏à‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡∏û‡∏ö‡∏ß‡πà‡∏≤‡∏û‡∏ß‡∏Å‡πÄ‡∏Ç‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÉ‡∏´‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏Å‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô‡πÅ‡∏Å‡πà‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏Å "
                        f"‡πÉ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå ‡∏£‡∏≤‡∏®‡∏µ{zodiac_sign}‡∏°‡∏±‡∏Å‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏à‡∏≤‡∏Å‡∏Ñ‡∏π‡πà‡∏£‡∏±‡∏Å\n\n"
                        f"‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏µ‡∏°‡∏á‡∏Ñ‡∏•‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏®‡∏µ{zodiac_sign} ‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏á‡∏ö ‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏µ‡πÄ‡∏ö‡∏à ‡∏ã‡∏∂‡πà‡∏á‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏ú‡πà‡∏≠‡∏ô‡∏Ñ‡∏•‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏™‡∏°‡∏≤‡∏ò‡∏¥‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ñ‡πà‡∏∞"
                    )
                    
                    prediction = header + body
                    logger.info(f"‚úÖ Used deterministic fallback prediction (len={len(prediction)})")
            except Exception as top_fallback_err:
                logger.warning(f"Top-level fallback generation failed: {top_fallback_err}")

        return prediction
    except Exception as e:
        logger.error(f"Error in RAG system: {e}")
        return "‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ‡πÄ‡∏Å‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á"

def create_birth_chart_query(chart_info: dict, birth_info: dict) -> str:
    """
    ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö RAG system ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏î‡∏ß‡∏á‡∏Å‡∏≥‡πÄ‡∏ô‡∏¥‡∏î
    
    Args:
        chart_info (dict): ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏ß‡∏á‡∏ä‡∏∞‡∏ï‡∏≤
        birth_info (dict): ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Å‡∏¥‡∏î ‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î
        
    Returns:
        str: ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö RAG system
    """
    # ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ó‡∏¢
    day, month, year = map(int, birth_info['date'].split('/'))
    thai_year = year + 543
    
    # ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ó‡∏¢
    thai_months = [
        '', '‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô',
        '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'
    ]
    
    # ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ó‡∏¢
    thai_days = [
        '‡∏ß‡∏±‡∏ô‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå', '‡∏ß‡∏±‡∏ô‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£', '‡∏ß‡∏±‡∏ô‡∏û‡∏∏‡∏ò', '‡∏ß‡∏±‡∏ô‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ', '‡∏ß‡∏±‡∏ô‡∏®‡∏∏‡∏Å‡∏£‡πå', '‡∏ß‡∏±‡∏ô‡πÄ‡∏™‡∏≤‡∏£‡πå', '‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå'
    ]
    
    # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ß‡∏±‡∏ô‡πÉ‡∏ô‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå
    from datetime import datetime
    birth_datetime = datetime(year, month, day)
    day_of_week = thai_days[birth_datetime.weekday()]
    
    # üÜï ‡∏™‡∏£‡πâ‡∏≤‡∏á query ‡∏ó‡∏µ‡πà‡∏™‡∏±‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏®‡∏µ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô
    zodiac_sign = chart_info['zodiac_sign']
    
    # ‡∏™‡∏£‡πâ‡∏≤‡∏á query ‡πÅ‡∏ö‡∏ö‡∏™‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏®‡∏µ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å
    query = f"‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏î‡∏ß‡∏á‡∏Å‡∏≥‡πÄ‡∏ô‡∏¥‡∏î‡∏£‡∏≤‡∏®‡∏µ{zodiac_sign} ‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏ô‡∏¥‡∏™‡∏±‡∏¢ ‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô ‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏Å"
    
    # ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏ñ‡πâ‡∏≤‡∏°‡∏µ (‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏ó‡∏≥‡πÉ‡∏´‡πâ query ‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ)
    if 'ascendant' in chart_info:
        ascendant = chart_info['ascendant']
        query += f" ‡∏•‡∏±‡∏Ñ‡∏ì‡∏≤‡∏£‡∏≤‡∏®‡∏µ{ascendant['sign']}"
    
    return query


if __name__ == "__main__":
    # ‡∏ó‡∏î‡∏™‡∏≠‡∏ö parser
    parser = BirthDateParser()
    parser.test_parser()
    
    
    # ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏î‡∏ß‡∏á‡∏Å‡∏≥‡πÄ‡∏ô‡∏¥‡∏î
    test_birth_chart_prediction()