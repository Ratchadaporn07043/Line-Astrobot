# คู่มือระบบการจัดการบริบท (Context Management)

## ภาพรวม

ระบบการจัดการบริบทช่วยให้แชทบอทโหราศาสตร์สามารถจดจำข้อมูลผู้ใช้และตอบคำถามแบบต่อเนื่องได้อย่างถูกต้อง โดยไม่เปลี่ยนราศีหรือข้อมูลเดิมเมื่อผู้ใช้ถามคำถามต่อเนื่อง

## ปัญหาที่แก้ไข

**ก่อนแก้ไข:**
- ผู้ใช้: "09/02/2004 ราศีอะไร"
- บอท: "คุณเป็นราศีกุมภ์ (Aquarius)..."
- ผู้ใช้: "แล้วราศีนี้มีลักษณะนิสัยยังไง"
- บอท: "ขอบคุณที่ให้ความสนใจ... เกิดวันที่ 26 กันยายน ราศีตุล (Libra)..." ❌

**หลังแก้ไข:**
- ผู้ใช้: "09/02/2004 ราศีอะไร"
- บอท: "คุณเป็นราศีกุมภ์ (Aquarius)..."
- ผู้ใช้: "แล้วราศีนี้มีลักษณะนิสัยยังไง"
- บอท: "ราศีกุมภ์มีลักษณะนิสัย..." ✅

## ฟีเจอร์หลัก

### 1. การจดจำข้อมูลผู้ใช้
- วันเกิดและเวลาเกิด
- ราศีอาทิตย์ (Sun Sign)
- ธาตุและคุณภาพของราศี
- ประวัติการสนทนา

### 2. การปรับปรุงคำถามอัตโนมัติ
- เปลี่ยน "ราศีนี้" → "ราศีกุมภ์"
- เปลี่ยน "ราศีของฉัน" → "ราศีกุมภ์"
- เปลี่ยน "ดวงชะตา" → "ดวงชะตาราศีกุมภ์"

### 3. การบันทึกบริบทใน MongoDB
- เก็บข้อมูลใน collection `user_profiles`
- อัปเดตข้อมูลเมื่อมีการสนทนาใหม่
- ดึงข้อมูลบริบทเมื่อผู้ใช้ถามคำถามต่อเนื่อง

## โครงสร้างข้อมูล

### User Profile Schema
```json
{
  "_id": "ObjectId",
  "user_id": "string",
  "birth_date": "09/02/2004",
  "zodiac_sign": "กุมภ์",
  "zodiac_element": "ลม",
  "zodiac_quality": "Fixed",
  "birth_time": "14:30",
  "question": "คำถามล่าสุด",
  "response": "คำตอบล่าสุด",
  "embedding": [0.1, 0.2, ...],
  "created_at": "2024-01-01T00:00:00Z",
  "updated_at": "2024-01-01T00:00:00Z"
}
```

## ฟังก์ชันหลัก

### 1. `get_user_context(user_id)`
ดึงข้อมูลบริบทการสนทนาของผู้ใช้

```python
context = get_user_context("user_123")
# Returns: {
#   "birth_date": "09/02/2004",
#   "zodiac_sign": "กุมภ์",
#   "zodiac_element": "ลม",
#   "zodiac_quality": "Fixed",
#   "last_question": "09/02/2004 ราศีอะไร",
#   "last_response": "คุณเป็นราศีกุมภ์...",
#   "updated_at": "2024-01-01T00:00:00Z"
# }
```

### 2. `enhance_question_context(question, user_context)`
ปรับปรุงคำถามให้ชัดเจนขึ้นโดยใช้ข้อมูลบริบท

```python
enhanced = enhance_question_context(
    "แล้วราศีนี้มีลักษณะนิสัยยังไง",
    {"zodiac_sign": "กุมภ์"}
)
# Returns: "ราศีกุมภ์ แล้วราศีนี้มีลักษณะนิสัยยังไง"
```

### 3. `log_user_interaction(question, answer, embedding, user_id, context_data)`
บันทึกการโต้ตอบพร้อมข้อมูลบริบท

```python
log_user_interaction(
    question="09/02/2004 ราศีอะไร",
    answer="คุณเป็นราศีกุมภ์...",
    embedding=[0.1, 0.2, ...],
    user_id="user_123",
    context_data={
        "zodiac_sign": "กุมภ์",
        "zodiac_element": "ลม",
        "birth_date": "09/02/2004"
    }
)
```

## การใช้งาน

### 1. การตั้งค่า
ไม่ต้องตั้งค่าเพิ่มเติม ระบบจะทำงานอัตโนมัติเมื่อมีการสนทนา

### 2. การทดสอบ
รันสคริปต์ทดสอบ:
```bash
python3 test_context_management.py
```

### 3. การตรวจสอบข้อมูล
ดูข้อมูลใน MongoDB:
```javascript
// ดูโปรไฟล์ผู้ใช้
db.user_profiles.findOne({"user_id": "user_123"})

// ดูประวัติการสนทนา
db.user_profiles.find({"user_id": "user_123"}).sort({"updated_at": -1})
```

## ตัวอย่างการทำงาน

### สถานการณ์ที่ 1: คำถามต่อเนื่อง
```
ผู้ใช้: "09/02/2004 ราศีอะไร"
บอท: "คุณเป็นราศีกุมภ์ (Aquarius) เกิดวันที่ 9 กุมภาพันธ์ 2004..."

ผู้ใช้: "แล้วราศีนี้มีลักษณะนิสัยยังไง"
ระบบ: ใช้บริบท "กุมภ์" → "ราศีกุมภ์ แล้วราศีนี้มีลักษณะนิสัยยังไง"
บอท: "ราศีกุมภ์มีลักษณะนิสัยเป็นคนอิสระ..."
```

### สถานการณ์ที่ 2: คำถามทั่วไป
```
ผู้ใช้: "สีมงคลของราศีนี้คืออะไร"
ระบบ: ใช้บริบท "กุมภ์" → "ราศีกุมภ์ สีมงคลของราศีนี้คืออะไร"
บอท: "สีมงคลของราศีกุมภ์คือ..."
```

## การบำรุงรักษา

### 1. การล้างข้อมูลเก่า
```python
# ลบข้อมูลผู้ใช้ที่ไม่ได้ใช้งานนาน
from datetime import datetime, timedelta
cutoff_date = datetime.utcnow() - timedelta(days=90)
db.user_profiles.delete_many({"updated_at": {"$lt": cutoff_date}})
```

### 2. การสำรองข้อมูล
```bash
# สำรองข้อมูล user_profiles
mongodump --db astrobot_summary --collection user_profiles --out backup/
```

### 3. การตรวจสอบประสิทธิภาพ
```python
# ตรวจสอบจำนวนผู้ใช้
db.user_profiles.count()

# ตรวจสอบผู้ใช้ที่ใช้งานบ่อย
db.user_profiles.aggregate([
  {"$group": {"_id": "$user_id", "count": {"$sum": 1}}},
  {"$sort": {"count": -1}},
  {"$limit": 10}
])
```

## ข้อควรระวัง

1. **ความเป็นส่วนตัว**: ข้อมูลผู้ใช้ถูกเก็บในฐานข้อมูล ต้องมีการจัดการความปลอดภัย
2. **การลบข้อมูล**: ระบบจะเก็บข้อมูลตลอดไป ต้องมีการล้างข้อมูลเก่า
3. **ประสิทธิภาพ**: ข้อมูลเพิ่มขึ้นเรื่อยๆ ต้องมีการจัดทำ index
4. **ความถูกต้อง**: ข้อมูลราศีต้องคำนวณจากวันเกิดที่ถูกต้อง

## การพัฒนาต่อ

1. **การจำกัดเวลา**: ลบข้อมูลบริบทหลังจากเวลาที่กำหนด
2. **การแชร์ข้อมูล**: อนุญาตให้ผู้ใช้ลบข้อมูลของตัวเอง
3. **การวิเคราะห์**: วิเคราะห์รูปแบบการใช้งานของผู้ใช้
4. **การแจ้งเตือน**: แจ้งเตือนเมื่อข้อมูลบริบทไม่ถูกต้อง

## สรุป

ระบบการจัดการบริบทช่วยให้แชทบอทโหราศาสตร์สามารถ:
- จดจำข้อมูลผู้ใช้ได้อย่างถูกต้อง
- ตอบคำถามต่อเนื่องได้โดยไม่เปลี่ยนบริบท
- ให้ประสบการณ์การใช้งานที่ดีขึ้น
- ลดความสับสนของผู้ใช้

ระบบนี้ทำงานอัตโนมัติและไม่ต้องการการตั้งค่าเพิ่มเติม ทำให้แชทบอทสามารถให้บริการที่ดีขึ้นได้ทันที
